<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í†µê³„ - í¬íŠ¸í™€ ê´€ì œ ì‹œìŠ¤í…œ</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8f9fa; }
        .navbar-brand { font-weight: 700; }
        .card { margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: none; }
        .card-header { background-color: #fff; border-bottom: 1px solid #eee; font-weight: 700; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        
        /* ë ˆì´ì•„ì›ƒ ìŠ¤íƒ€ì¼ (map.htmlê³¼ ìœ ì‚¬) */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        .main-container { display: flex; flex-direction: column; height: 100%; }
        .content-wrapper { display: flex; flex-grow: 1; overflow: hidden; }
        .stats-content { flex-grow: 1; overflow-y: auto; padding: 2rem; }
        .sidebar { width: 250px; background-color: #fff; border-left: 1px solid #dee2e6; overflow-y: auto; padding: 1rem; flex-shrink: 0; }
        
        /* íŠ¸ë¦¬ ë©”ë‰´ ìŠ¤íƒ€ì¼ */
        .region-item { margin-bottom: 2px; }
        .region-header { display: flex; align-items: center; padding: 4px 0; cursor: pointer; }
        .region-header:hover .region-name { color: #0d6efd; font-weight: bold; }
        .toggle-btn { width: 20px; text-align: center; margin-right: 5px; font-weight: bold; cursor: pointer; user-select: none; color: #555; }
        .region-name { flex-grow: 1; font-size: 0.95rem; }
        .sub-regions { margin-left: 18px; display: none; border-left: 1px solid #eee; padding-left: 5px; }
        .sub-regions.open { display: block; }
    </style>
</head>
<body>
    <div class="main-container">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="/dashboard">ğŸš¨ í¬íŠ¸í™€ ê´€ì œ ì‹œìŠ¤í…œ</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav">
                        <li class="nav-item"><a class="nav-link" href="/dashboard">í…Œì´ë¸” ë·°</a></li>
                        <li class="nav-item"><a class="nav-link" href="/map">ì§€ë„ ë·°</a></li>
                        <li class="nav-item"><a class="nav-link active" href="/stats">í†µê³„</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="content-wrapper">
            <!-- ë©”ì¸ í†µê³„ ì˜ì—­ -->
            <div class="stats-content">
                <h2 class="mb-4">ğŸ“Š ì‹ ê³  í†µê³„ í˜„í™© <span id="currentRegionBadge" class="badge bg-secondary fs-6 align-middle">ì „ì²´</span></h2>
                
                <div class="row">
                    <!-- ìƒíƒœë³„ ë¹„ìœ¨ -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">ìƒíƒœë³„ ì‹ ê³  ë¹„ìœ¨</div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="statusChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì¼ë³„ ì‹ ê³  ì¶”ì´ -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">ìµœê·¼ ì¼ë³„ ì‹ ê³  ì¶”ì´</div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="dailyChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ì§€ì—­ë³„ ì‹ ê³  í˜„í™© -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">ì§€ì—­ë³„ ì‹ ê³  í˜„í™© (ìƒìœ„ 10ê°œ ì§€ì—­)</div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="regionChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°”: ì§€ì—­ ì„ íƒ -->
            <div class="sidebar">
                <h5 class="mb-3">ì§€ì—­ ì„ íƒ</h5>
                <button class="btn btn-outline-primary btn-sm w-100 mb-3" onclick="resetFilter()">ì „ì²´ ë³´ê¸°</button>
                <div id="city-buttons"></div>
            </div>
        </div>
    </div>

    <!-- Chart.js & Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ë°ì´í„°
        const allReports = JSON.parse('{{ reports_data | safe }}');
        let chartInstances = {}; // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì €ì¥ìš©

        // ì°¨íŠ¸ ì´ˆê¸°í™” ë° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateCharts(filteredReports) {
            // 1. ìƒíƒœë³„ ë°ì´í„° ê°€ê³µ
            const statusCounts = {};
            filteredReports.forEach(r => {
                statusCounts[r.status] = (statusCounts[r.status] || 0) + 1;
            });

            // 2. ì¼ë³„ ë°ì´í„° ê°€ê³µ
            const dailyCounts = {};
            filteredReports.forEach(r => {
                const date = r.reported_at.split('T')[0]; // YYYY-MM-DD
                dailyCounts[date] = (dailyCounts[date] || 0) + 1;
            });
            const sortedDates = Object.keys(dailyCounts).sort();
            const dailyData = sortedDates.map(date => dailyCounts[date]);

            // 3. ì§€ì—­ë³„ ë°ì´í„° ê°€ê³µ
            const regionCounts = {};
            filteredReports.forEach(r => {
                if (r.closestRegion) {
                    regionCounts[r.closestRegion] = (regionCounts[r.closestRegion] || 0) + 1;
                }
            });

            // ê¸°ì¡´ ì°¨íŠ¸ íŒŒê´´ (ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´)
            if (chartInstances.status) chartInstances.status.destroy();
            if (chartInstances.daily) chartInstances.daily.destroy();
            if (chartInstances.region) chartInstances.region.destroy();

            // ìƒíƒœë³„ íŒŒì´ ì°¨íŠ¸
            const ctxStatus = document.getElementById('statusChart').getContext('2d');
            chartInstances.status = new Chart(ctxStatus, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#cc65fe', '#4bc0c0'],
                    }]
                },
                options: { maintainAspectRatio: false }
            });

            // ì¼ë³„ ë¼ì¸ ì°¨íŠ¸
            const ctxDaily = document.getElementById('dailyChart').getContext('2d');
            chartInstances.daily = new Chart(ctxDaily, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'ì‹ ê³  ê±´ìˆ˜',
                        data: dailyData,
                        borderColor: '#36a2eb',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });

            // ì§€ì—­ë³„ ë°” ì°¨íŠ¸
            const sortedRegions = Object.entries(regionCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const ctxRegion = document.getElementById('regionChart').getContext('2d');
            chartInstances.region = new Chart(ctxRegion, {
                type: 'bar',
                data: {
                    labels: sortedRegions.map(item => item[0]),
                    datasets: [{
                        label: 'ì‹ ê³  ê±´ìˆ˜',
                        data: sortedRegions.map(item => item[1]),
                        backgroundColor: '#4bc0c0'
                    }]
                },
                options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });
        }

        // ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (Haversine formula)
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the earth in km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
        function deg2rad(deg) { return deg * (Math.PI / 180); }

        // ì§€ì—­ ë°ì´í„° ë¡œë“œ ë° ì²˜ë¦¬
        fetch('/static/data/regions.json')
            .then(res => res.json())
            .then(regions => {
                // ê° ë¦¬í¬íŠ¸ì— ì§€ì—­ ì •ë³´ ë§¤í•‘
                allReports.forEach(report => {
                    let minDistance = Infinity;
                    let closestCity = null;
                    let closestDistrict = null;
                    let closestRegionName = 'ì•Œ ìˆ˜ ì—†ìŒ';
                    let closestCityObj = null;

                    // 1ë‹¨ê³„: ê°€ì¥ ê°€ê¹Œìš´ ì‹œ/ë„(Top-level) ì°¾ê¸°
                    regions.forEach(city => {
                        const dist = getDistanceFromLatLonInKm(report.latitude, report.longitude, city.lat, city.lng);
                        if (dist < minDistance) {
                            minDistance = dist;
                            closestCityObj = city;
                        }
                    });

                    if (closestCityObj) {
                        closestCity = closestCityObj.name;
                        closestRegionName = closestCityObj.name;

                        // 2ë‹¨ê³„: í•´ë‹¹ ì‹œ/ë„ ë‚´ì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ êµ¬/êµ° ì°¾ê¸°
                        if (closestCityObj.children && closestCityObj.children.length > 0) {
                            let minSubDistance = Infinity;
                            let closestSubObj = null;

                            closestCityObj.children.forEach(sub => {
                                const subDist = getDistanceFromLatLonInKm(report.latitude, report.longitude, sub.lat, sub.lng);
                                if (subDist < minSubDistance) {
                                    minSubDistance = subDist;
                                    closestSubObj = sub;
                                }
                            });

                            // ì§€ë°©ì˜ ê²½ìš° í–‰ì •êµ¬ì—­ì´ ë„“ìœ¼ë¯€ë¡œ ê±°ë¦¬ ì œí•œì„ 50kmë¡œ ì™„í™” (ê¸°ì¡´ 15kmëŠ” ë„ˆë¬´ ì¢ìŒ)
                            if (closestSubObj && minSubDistance < 50) {
                                closestDistrict = closestSubObj.name;
                                closestRegionName = `${closestCity} ${closestSubObj.name}`;
                            }
                        }
                    }
                    
                    report.city = closestCity;
                    report.district = closestDistrict;
                    report.closestRegion = closestRegionName;
                });

                // ì´ˆê¸° ë Œë”ë§ (ì „ì²´)
                updateCharts(allReports);

                // ì‚¬ì´ë“œë°” ìƒì„±
                createRegionTree(document.getElementById('city-buttons'), regions);
            })
            .catch(err => console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err));

        // ì‚¬ì´ë“œë°” íŠ¸ë¦¬ ìƒì„± í•¨ìˆ˜
        function createRegionTree(container, data) {
            data.forEach(region => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'region-item';

                const headerDiv = document.createElement('div');
                headerDiv.className = 'region-header';

                const toggleBtn = document.createElement('span');
                toggleBtn.className = 'toggle-btn';
                const hasChildren = region.children && region.children.length > 0;
                
                if (hasChildren) {
                    toggleBtn.innerText = '+';
                } else {
                    toggleBtn.innerText = 'â€¢';
                    toggleBtn.style.color = '#ccc';
                    toggleBtn.style.cursor = 'default';
                }
                headerDiv.appendChild(toggleBtn);

                const nameSpan = document.createElement('span');
                nameSpan.className = 'region-name';
                nameSpan.innerText = region.name;
                
                // í´ë¦­ ì´ë²¤íŠ¸: í•„í„°ë§
                nameSpan.onclick = function() {
                    filterByRegion(region.name, null); // ì‹œ/ë„ ì„ íƒ
                };
                headerDiv.appendChild(nameSpan);

                itemDiv.appendChild(headerDiv);

                if (hasChildren) {
                    const subContainer = document.createElement('div');
                    subContainer.className = 'sub-regions';
                    
                    // í•˜ìœ„ ì§€ì—­ ì¬ê·€ í˜¸ì¶œ (êµ¬/êµ°)
                    region.children.forEach(child => {
                        const childDiv = document.createElement('div');
                        childDiv.className = 'region-item';
                        const childHeader = document.createElement('div');
                        childHeader.className = 'region-header';
                        
                        // í•˜ìœ„ëŠ” í† ê¸€ ì—†ìŒ (ë‹¨ë§ ë…¸ë“œ ê°€ì •)
                        const dot = document.createElement('span');
                        dot.className = 'toggle-btn';
                        dot.innerText = 'â€¢';
                        dot.style.color = '#ccc';
                        childHeader.appendChild(dot);

                        const childName = document.createElement('span');
                        childName.className = 'region-name';
                        childName.innerText = child.name;
                        childName.onclick = function() {
                            filterByRegion(region.name, child.name); // ì‹œ/ë„ + êµ¬/êµ° ì„ íƒ
                        };
                        childHeader.appendChild(childName);
                        
                        childDiv.appendChild(childHeader);
                        subContainer.appendChild(childDiv);
                    });

                    itemDiv.appendChild(subContainer);

                    toggleBtn.onclick = function() {
                        const isOpen = subContainer.classList.contains('open');
                        subContainer.classList.toggle('open');
                        toggleBtn.innerText = isOpen ? '+' : '-';
                    };
                }
                container.appendChild(itemDiv);
            });
        }

        function filterByRegion(city, district) {
            let filtered = [];
            let label = "ì „ì²´";

            if (district) {
                filtered = allReports.filter(r => r.city === city && r.district === district);
                label = `${city} ${district}`;
            } else {
                filtered = allReports.filter(r => r.city === city);
                label = city;
            }

            document.getElementById('currentRegionBadge').innerText = label;
            updateCharts(filtered);
        }

        function resetFilter() {
            document.getElementById('currentRegionBadge').innerText = "ì „ì²´";
            updateCharts(allReports);
        }
    </script>
</body>
</html>