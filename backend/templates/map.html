<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§€ë„ ë·° - í¬íŠ¸í™€ ì‹ ê³  ëŒ€ì‹œë³´ë“œ</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts (Noto Sans KR) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f8f9fa;
        }
        .navbar-brand {
            font-weight: 700;
        }
        /* ì§€ë„ê°€ í™”ë©´ì˜ ë‚¨ì€ ë¶€ë¶„ì„ ê½‰ ì±„ìš°ë„ë¡ ì„¤ì • */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        .main-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        #map {
            flex-grow: 1; /* ë„¤ë¹„ê²Œì´ì…˜ ë°”ë¥¼ ì œì™¸í•œ ëª¨ë“  ê³µê°„ì„ ì°¨ì§€ */
        }
        .content-wrapper {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
            position: relative;
        }
        .sidebar {
            width: 280px;
            background-color: #fff;
            overflow-y: auto;
            transition: margin 0.3s ease;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }
        .left-sidebar {
            border-right: 1px solid #dee2e6;
        }
        .right-sidebar {
            border-left: 1px solid #dee2e6;
        }
        .sidebar.collapsed {
            margin-left: -280px; /* Left sidebar collapse */
        }
        .right-sidebar.collapsed {
            margin-left: 0;
            margin-right: -280px; /* Right sidebar collapse */
        }
        
        /* Map Toggle Buttons */
        .map-toggle-btn {
            position: absolute;
            top: 10px;
            z-index: 900;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border: 1px solid #ccc;
            background: #fff;
            font-weight: bold;
            color: #333;
        }
        .left-toggle-btn { left: 10px; }
        .right-toggle-btn { right: 10px; }
        
        /* List Group Item Hover */
        .list-group-item-action { cursor: pointer; }
        .list-group-item.active { background-color: #e7f1ff; color: #000; border-color: #dee2e6; }
        
        /* íŠ¸ë¦¬ ë©”ë‰´ ìŠ¤íƒ€ì¼ */
        .region-item {
            margin-bottom: 2px;
        }
        .region-header {
            display: flex;
            align-items: center;
            padding: 4px 0;
            cursor: pointer;
        }
        .region-header:hover .region-name {
            color: #0d6efd;
            font-weight: bold;
        }
        .toggle-btn {
            width: 20px;
            text-align: center;
            margin-right: 5px;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            color: #555;
        }
        .region-name {
            flex-grow: 1;
            font-size: 0.95rem;
        }
        .sub-regions {
            margin-left: 18px;
            display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
            border-left: 1px solid #eee;
            padding-left: 5px;
        }
        .sub-regions.open {
            display: block;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="/dashboard">ğŸš¨ í¬íŠ¸í™€ ê´€ì œ ì‹œìŠ¤í…œ</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav">
                        <li class="nav-item"><a class="nav-link" href="/dashboard">í…Œì´ë¸” ë·°</a></li>
                        <li class="nav-item"><a class="nav-link active" href="/map">ì§€ë„ ë·°</a></li>
                        <li class="nav-item"><a class="nav-link" href="/stats">í†µê³„</a></li>
                        <li class="nav-item"><a class="nav-link" href="/debug">ë””ë²„ê¹…</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="content-wrapper">
            <!-- Left Sidebar: Pothole Groups -->
            <div class="sidebar left-sidebar" id="leftSidebar">
                <div class="d-flex justify-content-between align-items-center p-3 border-bottom bg-light">
                    <h6 class="mb-0 fw-bold">ğŸš§ í¬íŠ¸í™€ ê·¸ë£¹ ëª©ë¡</h6>
                    <button type="button" class="btn-close" aria-label="Close" onclick="toggleSidebar('left')"></button>
                </div>
                <div id="group-list" class="list-group list-group-flush overflow-auto" style="flex-grow: 1;">
                    <!-- Group items will be injected here -->
                </div>
            </div>

            <!-- Map Area -->
            <div style="position: relative; flex-grow: 1; display: flex;">
                <div id="map" style="width: 100%; height: 100%;"></div>
                
                <!-- Toggle Buttons (Visible when sidebar is collapsed) -->
                <button id="btn-open-left" class="btn btn-sm map-toggle-btn left-toggle-btn" onclick="toggleSidebar('left')" style="display: none;">
                    â˜° ëª©ë¡
                </button>
                <button id="btn-open-right" class="btn btn-sm map-toggle-btn right-toggle-btn" onclick="toggleSidebar('right')" style="display: none;">
                    ì§€ì—­ â˜°
                </button>
            </div>
            
            <!-- Right Sidebar: Regions -->
            <div class="sidebar right-sidebar" id="rightSidebar">
                <div class="d-flex justify-content-between align-items-center p-3 border-bottom bg-light">
                    <h6 class="mb-0 fw-bold">ğŸ—ºï¸ ì§€ì—­ ì´ë™</h6>
                    <button type="button" class="btn-close" aria-label="Close" onclick="toggleSidebar('right')"></button>
                </div>
                <div id="city-buttons" class="p-3 overflow-auto" style="flex-grow: 1;"></div>
            </div>
        </div>
    </div>

    <!-- 
        ì¹´ì¹´ì˜¤ë§µ API ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ
        [ì¤‘ìš”] ì•„ë˜ URLì˜ 'YOUR_APP_KEY' ë¶€ë¶„ì— ë°œê¸‰ë°›ì€ ì¹´ì¹´ì˜¤ JavaScript ì•± í‚¤ë¥¼ ê¼­ ë„£ì–´ì£¼ì„¸ìš”.
        &autoload=false íŒŒë¼ë¯¸í„°ë¥¼ ì¶”ê°€í•˜ì—¬, ìŠ¤í¬ë¦½íŠ¸ê°€ ë¡œë“œëœ í›„ ìˆ˜ë™ìœ¼ë¡œ ì§€ë„ë¥¼ ì´ˆê¸°í™”í•˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.
    -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=24674ffcd6a9cbb689255565a15f4e17"></script>
    
    <script>
        kakao.maps.load(function() {
            const mapContainer = document.getElementById('map');
            const mapOption = {
                center: new kakao.maps.LatLng(37.8813, 127.7300), // ì¶˜ì²œì‹œì²­ ì¢Œí‘œ
                level: 5 // ê°•ì›ë„ ì§€ì—­ì„ ê³ ë ¤í•˜ì—¬ ì¡°ê¸ˆ ë” ë„“ê²Œ í‘œì‹œ
            };

            const map = new kakao.maps.Map(mapContainer, mapOption);

            // [ë³€ê²½] ê³„ì¸µí˜• ì§€ì—­ ë©”ë‰´ ìƒì„± í•¨ìˆ˜
            const cityBtnContainer = document.getElementById('city-buttons');
            
            function createRegionTree(container, data) {
                data.forEach(region => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'region-item';

                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'region-header';

                    // í† ê¸€ ë²„íŠ¼ (+/-)
                    const toggleBtn = document.createElement('span');
                    toggleBtn.className = 'toggle-btn';
                    const hasChildren = region.children && region.children.length > 0;
                    
                    if (hasChildren) {
                        toggleBtn.innerText = '+';
                    } else {
                        toggleBtn.innerText = 'â€¢'; // í•˜ìœ„ í•­ëª© ì—†ìœ¼ë©´ ì  í‘œì‹œ
                        toggleBtn.style.color = '#ccc';
                        toggleBtn.style.cursor = 'default';
                    }
                    headerDiv.appendChild(toggleBtn);

                    // ì§€ì—­ ì´ë¦„ (í´ë¦­ ì‹œ ì´ë™)
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'region-name';
                    nameSpan.innerText = region.name;
                    nameSpan.onclick = function() {
                        const moveLatLon = new kakao.maps.LatLng(region.lat, region.lng);
                        const zoomLevel = region.level || 5;
                        map.setLevel(zoomLevel);
                        map.panTo(moveLatLon);
                    };
                    headerDiv.appendChild(nameSpan);

                    itemDiv.appendChild(headerDiv);

                    // í•˜ìœ„ ëª©ë¡ ì»¨í…Œì´ë„ˆ
                    if (hasChildren) {
                        const subContainer = document.createElement('div');
                        subContainer.className = 'sub-regions';
                        createRegionTree(subContainer, region.children);
                        itemDiv.appendChild(subContainer);

                        // í† ê¸€ ì´ë²¤íŠ¸
                        toggleBtn.onclick = function() {
                            const isOpen = subContainer.classList.contains('open');
                            subContainer.classList.toggle('open');
                            toggleBtn.innerText = isOpen ? '+' : '-';
                        };
                    }
                    container.appendChild(itemDiv);
                });
            }

            // [ì¶”ê°€] 1. í˜„ì¬ ì—´ë ¤ìˆëŠ” ì¸í¬ìœˆë„ìš°ë¥¼ ì¶”ì í•˜ê¸° ìœ„í•œ ë³€ìˆ˜ (í•˜ë‚˜ë§Œ ë„ìš°ê¸° ìœ„í•¨)
            let activeInfoWindow = null;

            // [ì¶”ê°€] ì‚¬ì´ë“œë°” í† ê¸€ í•¨ìˆ˜
            window.toggleSidebar = function(side) {
                const sidebar = document.getElementById(side + 'Sidebar');
                const btn = document.getElementById('btn-open-' + side);
                
                if (sidebar.classList.contains('collapsed')) {
                    sidebar.classList.remove('collapsed');
                    btn.style.display = 'none';
                    localStorage.setItem(side + 'SidebarState', 'open');
                } else {
                    sidebar.classList.add('collapsed');
                    btn.style.display = 'block';
                    localStorage.setItem(side + 'SidebarState', 'closed');
                }
                // ì‚¬ì´ë“œë°” ë³€ê²½ í›„ ì§€ë„ í¬ê¸° ì¬ê³„ì‚°
                setTimeout(() => map.relayout(), 300);
            };

            // [ì¶”ê°€] í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ì‚¬ì´ë“œë°” ìƒíƒœ ë³µì›
            (function restoreSidebarState() {
                ['left', 'right'].forEach(side => {
                    const state = localStorage.getItem(side + 'SidebarState');
                    if (state === 'closed') {
                        const sidebar = document.getElementById(side + 'Sidebar');
                        const btn = document.getElementById('btn-open-' + side);
                        sidebar.classList.add('collapsed');
                        btn.style.display = 'block';
                    }
                });
                setTimeout(() => map.relayout(), 100);
            })();

            // [ë³µêµ¬] ê·¸ë£¹ IDë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê³ ìœ í•œ ìƒ‰ìƒì„ ìƒì„±í•˜ëŠ” í•¨ìˆ˜ (ë°˜ê²½ í‘œì‹œìš©)
            function getGroupColorById(id) {
                let hash = 0;
                for (let i = 0; i < id.length; i++) {
                    hash = id.charCodeAt(i) + ((hash << 5) - hash);
                }
                const h = Math.abs(hash % 360);
                return { stroke: `hsl(${h}, 70%, 45%)`, fill: `hsl(${h}, 90%, 85%)` };
            }

            // [ì¶”ê°€] ìƒíƒœì— ë”°ë¼ í•€ ìƒ‰ìƒì„ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜ (ë§ˆì»¤ í‘œì‹œìš©)
            function getStatusColor(status) {
                switch (status) {
                    case 'ì ‘ìˆ˜ë¨': return '#dc3545'; // ë¹¨ê°•
                    case 'ì²˜ë¦¬ì¤‘': return '#fd7e14'; // ì£¼í™©
                    case 'ì™„ë£Œ': return '#198754'; // ì´ˆë¡
                    case 'í¬íŠ¸í™€ì•„ë‹˜': return '#6c757d'; // íšŒìƒ‰
                    default: return '#0d6efd'; // íŒŒë‘
                }
            }

            // [ì¶”ê°€] ì „ì—­ ë³€ìˆ˜ë¡œ ì§€ì—­ ë°ì´í„° ì €ì¥
            let regionData = [];

            // [ì¶”ê°€] ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (Haversine formula)
            function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
                const R = 6371; 
                const dLat = (lat2 - lat1) * (Math.PI / 180);
                const dLon = (lon2 - lon1) * (Math.PI / 180);
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                          Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
                          Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }

            // [ì¶”ê°€] ì¢Œí‘œë¡œ ì§€ì—­ ì°¾ê¸° í•¨ìˆ˜
            function getRegionFromCoords(lat, lng) {
                if (!regionData || regionData.length === 0) return "";
                
                let minDistance = Infinity;
                let closestCity = null;

                // 1ë‹¨ê³„: ì‹œ/ë„ ì°¾ê¸°
                regionData.forEach(city => {
                    const dist = getDistanceFromLatLonInKm(lat, lng, city.lat, city.lng);
                    if (dist < minDistance) {
                        minDistance = dist;
                        closestCity = city;
                    }
                });

                if (!closestCity) return "";

                // 2ë‹¨ê³„: êµ¬/êµ° ì°¾ê¸°
                let regionName = closestCity.name;
                if (closestCity.children && closestCity.children.length > 0) {
                    let minSubDistance = Infinity;
                    let closestSubObj = null;
                    
                    closestCity.children.forEach(sub => {
                        const subDist = getDistanceFromLatLonInKm(lat, lng, sub.lat, sub.lng);
                        if (subDist < minSubDistance) {
                            minSubDistance = subDist;
                            closestSubObj = sub;
                        }
                    });
                    
                    // 50km ì´ë‚´ë©´ êµ¬/êµ°ê¹Œì§€ í‘œì‹œ
                    if (closestSubObj && minSubDistance < 50) {
                        regionName += " " + closestSubObj.name;
                    }
                }
                return regionName;
            }

            // [ì¶”ê°€] ì§€ì—­ ì´ë¦„ìœ¼ë¡œ ìƒ‰ìƒ ìƒì„±
            function getRegionColor(name) {
                if (!name) return '#6c757d';
                const city = name.split(' ')[0]; // ì‹œ/ë„ ê¸°ì¤€ ìƒ‰ìƒ
                let hash = 0;
                for (let i = 0; i < city.length; i++) {
                    hash = city.charCodeAt(i) + ((hash << 5) - hash);
                }
                const h = Math.abs(hash % 360);
                return `hsl(${h}, 65%, 40%)`;
            }

            // [ìˆ˜ì •] ë°ì´í„° ë¡œë“œ ìˆœì„œ ë³€ê²½: regions.json -> pothole-groups
            fetch('/static/data/regions.json')
                .then(response => response.json())
                .then(data => {
                    regionData = data;
                    createRegionTree(cityBtnContainer, data);
                    return fetch('/api/pothole-groups');
                })
                .then(response => response.json())
                .then(groups => {
                    if (groups.length === 0) {
                        console.log("í‘œì‹œí•  í¬íŠ¸í™€ ê·¸ë£¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                        return;
                    }

                    // ëª¨ë“  ë§ˆì»¤ë¥¼ í¬í•¨í•  ìˆ˜ ìˆëŠ” ì˜ì—­ ê°ì²´ ìƒì„±
                    const bounds = new kakao.maps.LatLngBounds();

                    // [ì¶”ê°€] ì™¼ìª½ ì‚¬ì´ë“œë°” ë¦¬ìŠ¤íŠ¸ ì—˜ë¦¬ë¨¼íŠ¸
                    const groupListEl = document.getElementById('group-list');
                    groupListEl.innerHTML = ''; // ì´ˆê¸°í™”

                    groups.forEach(group => {
                        const markerPosition = new kakao.maps.LatLng(group.latitude, group.longitude);

                        // ì˜ì—­ í™•ì¥
                        bounds.extend(markerPosition);

                        const groupColors = getGroupColorById(group.group_id);
                        const statusColor = getStatusColor(group.status);

                        // [ì¶”ê°€] ì§€ì—­ ì •ë³´ ê³„ì‚°
                        const regionName = getRegionFromCoords(group.latitude, group.longitude);
                        const regionColor = getRegionColor(regionName);

                        // [ì¶”ê°€] ê·¸ë£¹ ìƒ‰ìƒì„ ì ìš©í•œ SVG ë§ˆì»¤ ì´ë¯¸ì§€ ìƒì„±
                        const svgMarker = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="40" viewBox="0 0 30 40">
                                <path fill="${groupColors.stroke}" d="M15 0C6.7 0 0 6.7 0 15c0 11 15 25 15 25s15-14 15-25c0-8.3-6.7-15-15-15zm0 20c-2.8 0-5-2.2-5-5s2.2-5 5-5 5 2.2 5 5-2.2 5-5 5z"/>
                            </svg>`;
                        
                        const markerImage = new kakao.maps.MarkerImage(
                            'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgMarker),
                            new kakao.maps.Size(30, 40), 
                            { offset: new kakao.maps.Point(15, 40) }
                        );

                        const marker = new kakao.maps.Marker({
                            position: markerPosition,
                            map: map,
                            image: markerImage // ì»¤ìŠ¤í…€ ë§ˆì»¤ ì´ë¯¸ì§€ ì„¤ì •
                        });

                        // [ì¶”ê°€] ê·¸ë£¹ ë°˜ê²½ í‘œì‹œ (ì› ê·¸ë¦¬ê¸°)
                        // ì„œë²„ì˜ DUPLICATE_RADIUS_METER ì„¤ì •(í˜„ì¬ 10m)ì— ë§ì¶° ë°˜ê²½ì„ í‘œì‹œí•©ë‹ˆë‹¤.
                        const circle = new kakao.maps.Circle({
                            center : markerPosition,  // ì›ì˜ ì¤‘ì‹¬ì¢Œí‘œ
                            radius: 10, // ë¯¸í„° ë‹¨ìœ„ì˜ ì›ì˜ ë°˜ì§€ë¦„
                            strokeWeight: 1, // ì„ ì˜ ë‘ê»˜
                            strokeColor: groupColors.stroke, // ì„ ì˜ ìƒ‰ê¹” (ê·¸ë£¹ë³„ ê³ ìœ ìƒ‰)
                            strokeOpacity: 0.8, // ì„ ì˜ ë¶ˆíˆ¬ëª…ë„
                            strokeStyle: 'solid', // ì„ ì˜ ìŠ¤íƒ€ì¼
                            fillColor: groupColors.fill, // ì±„ìš°ê¸° ìƒ‰ê¹” (ê·¸ë£¹ë³„ ê³ ìœ ìƒ‰)
                            fillOpacity: 0.5  // ì±„ìš°ê¸° ë¶ˆíˆ¬ëª…ë„
                        });
                        circle.setMap(map);

                        // ì¸í¬ìœˆë„ìš° ì»¨í…ì¸ : ê·¸ë£¹ ì •ë³´ í‘œì‹œ
                        const contentEl = document.createElement('div');
                        contentEl.className = 'infowindow-content';
                        contentEl.style.cssText = "padding:10px; min-width:220px; font-family: 'Noto Sans KR', sans-serif;";
                        contentEl.innerHTML = `
                            <div style="font-weight:bold; margin-bottom:5px; color:#333;">ğŸš§ í¬íŠ¸í™€ ê·¸ë£¹</div>
                            <div style="font-size:0.9em; margin-bottom:3px;">
                                <span style="color:#666;">ê·¸ë£¹ ID:</span> ${group.group_id}
                            </div>
                            <div style="font-size:0.9em; margin-bottom:3px;">
                                <span style="color:#666;">ìƒíƒœ:</span> 
                                <span class="badge" style="background-color:${statusColor}">${group.status}</span>
                            </div>
                            <div style="font-size:0.9em; margin-bottom:3px;">
                                <span style="color:#666;">ì‹ ê³  ê±´ìˆ˜:</span> 
                                <span class="badge bg-danger">${group.report_count}ê±´</span>
                            </div>
                            <div style="font-size:0.9em; background:#f8f9fa; padding:5px; border-radius:4px; margin-top:5px;">
                                <div style="color:#666; font-size:0.8em;">í¬í•¨ëœ ì‹ ê³  ID:</div>
                                <div style="font-family:monospace; word-break:break-all;">
                                    [ ${group.report_ids.join(', ')} ]
                                </div>
                            </div>
                        `;

                        const infowindow = new kakao.maps.InfoWindow({
                            content: contentEl,
                            removable: true
                        });

                        // [ì¶”ê°€] ì‚¬ì´ë“œë°” ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ìƒì„±
                        const listItem = document.createElement('a');
                        listItem.className = 'list-group-item list-group-item-action';
                        listItem.innerHTML = `
                            <div class="d-flex w-100 justify-content-between">
                                <small class="text-muted" style="font-size: 0.75rem;">${group.group_id.substring(0, 8)}...</small>
                                <span class="badge" style="background-color:${statusColor}">${group.status}</span>
                            </div>
                            <div class="mb-1 mt-1 fw-bold" style="font-size: 0.9rem;">
                                ì‹ ê³  ${group.report_count}ê±´
                            </div>
                            <div class="mb-1" style="font-size: 0.8rem; color: ${regionColor}; font-weight: 600;">
                                ğŸ“ ${regionName || 'ìœ„ì¹˜ ì •ë³´ ì—†ìŒ'}
                            </div>
                            <small class="text-muted">${new Date(group.latest_reported_at).toLocaleString()}</small>
                        `;
                        
                        // ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ í´ë¦­ ì´ë²¤íŠ¸
                        listItem.onclick = function() {
                            // ì´ë¯¸ í™œì„±í™”ëœ ìƒíƒœë¼ë©´ í•´ì œ (í† ê¸€ ê¸°ëŠ¥)
                            if (listItem.classList.contains('active')) {
                                listItem.classList.remove('active');
                                if (activeInfoWindow) {
                                    activeInfoWindow.close();
                                    activeInfoWindow = null;
                                }
                            } else {
                                // í™œì„±í™” ë¡œì§
                                if (map.getLevel() > 3) {
                                    map.setLevel(3, {animate: true});
                                }
                                map.panTo(markerPosition); // ì§€ë„ ì´ë™
                                if (activeInfoWindow) activeInfoWindow.close();
                                infowindow.open(map, marker); // ì¸í¬ìœˆë„ìš° ì—´ê¸°
                                activeInfoWindow = infowindow;
                                
                                // ë¦¬ìŠ¤íŠ¸ í™œì„±í™” ìŠ¤íƒ€ì¼ (ë‹¤ë¥¸ í•­ëª© ì´ˆê¸°í™”)
                                document.querySelectorAll('#group-list .list-group-item').forEach(el => el.classList.remove('active'));
                                listItem.classList.add('active');
                            }
                        };
                        groupListEl.appendChild(listItem);

                        kakao.maps.event.addListener(marker, 'click', function() {
                            // [ì¶”ê°€] 4. ë‹¤ë¥¸ ë§ˆì»¤ë¥¼ í´ë¦­í–ˆì„ ë•Œ ê¸°ì¡´ ì¸í¬ìœˆë„ìš° ë‹«ê¸° (UX í–¥ìƒ)
                            if (activeInfoWindow) {
                                activeInfoWindow.close();
                            }
                            infowindow.open(map, marker);
                            activeInfoWindow = infowindow; // í˜„ì¬ ì—´ë¦° ì°½ì„ ë³€ìˆ˜ì— ì €ì¥
                            
                            // [ì¶”ê°€] ë§ˆì»¤ í´ë¦­ ì‹œ ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œë„ í™œì„±í™” ë° ìŠ¤í¬ë¡¤ ì´ë™
                            document.querySelectorAll('#group-list .list-group-item').forEach(el => el.classList.remove('active'));
                            listItem.classList.add('active');
                            listItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        });
                    });

                    // ëª¨ë“  ë§ˆì»¤ê°€ ë³´ì´ë„ë¡ ì§€ë„ ë²”ìœ„ ì¬ì„¤ì •
                    map.setBounds(bounds);
                })
                .catch(error => console.error('Error loading data:', error));
        });
    </script>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
